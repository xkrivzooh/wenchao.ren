<!DOCTYPE html>
<html lang="zh-cn" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="" />
	
	
	
	<title>Error Prone的介绍和使用 ｜ 被遗忘的博客</title>
	
    
    
    <meta name="description" content="Error Prone的介绍和使用
今天在浏览GitHub的时候突然看到Google有一个项目Error Prone:
 Catch common Java mistakes as compile-time errors
 官方网站：https://errorprone.info/
Error Prone是什么？ 然后就翻看了一下官方文档了解了一下具体的作用。如果你之前没有了解过这个Error Prone，你可以把他对标为Snoar，FindBugs之类的静态代码分析工具就行。Error Prone就是Google研发的静态代码扫描工具，顾名思义，就是用于扫描Java各种易于出错的代码。
Error Prone产生的背景 Google在这篇论文Lessons from Building Static Analysis Tools at Google
 PDF Lessons from Building Static Analysis Tools at Google HTML Lessons from Building Static Analysis Tools at Google  中也提到了Google之前是如何做静态代码分析，以及Error Prone产生的一些原因。简单整理一下就是：
 Google内部早期使用FindBugs作为自己的静态代码分析工具，然后FindBug这种工具一般是定时触发重发，然后生成一个仪表盘，但是问题是大家一般都不会主动去翻看这个仪表盘，因为这个仪表盘不会在开发人员的常规工作流程中，于是Google内部发起了一个FixIt的小活动，简单说就是来集中几天解决这些发现的代码问题，后来他们将FindBugs等分析工具和Code Review工作结合起来搞了一个小平台，但是当时的内部整合不太好，使得开发人员觉的难用，也不怎么信任这个整合平台了。
 于是了，Google内部觉的，这种静态代码分析工作应该是参与到持续继承中，而且最好要快速，频繁，参与到开发人员的常规工作中，并且最好不但要发现问题，还要告诉开发人员怎么修。于是了，Google参考了之前Clang的一个经验，将静态代码分析工作整合到了javac，也就是在编译期来做静态代码分析工作，于是后来就有了这篇文章提到的Error Prone。
Error Prone的基本使用 我工作中一直使用的是Intellij&#43;JDK8&#43;Maven，所以参考官方文档https://errorprone.info/docs/installation，写了一个JDK8使用的小例子。下面贴一下核心代码。
首先是pom.xml中的配置，核心在于maven-compiler-plugin插件的配置, 同时因为大家项目开发过程中一般会使用Lombok等annotation processor依赖，所以下面的实例代码中也展示了ErrorProne如何和Lombok等依赖整合。
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt; &amp;lt;project xmlns=&amp;quot;http://maven.apache.org/POM/4.0.0&amp;quot; xmlns:xsi=&amp;quot;http://www.w3.org/2001/XMLSchema-instance&amp;quot; xsi:schemaLocation=&amp;quot;http://maven.apache.org/POM/4.0.0 https://maven." />
    

    
    
    <meta name="keywords" content="JAVA, Spring, IOT, KAFKA, python, mysql" />
    

	

    <style type="text/css">
    </style>

    <link rel="shortcut icon" href="https://wenchao.ren/images/favicon.ico" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://wenchao.ren/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://wenchao.ren/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://wenchao.ren/css/idea.css" />
    <script src="https://wenchao.ren/js/highlight.min.js"></script>
    <script src="https://wenchao.ren/js/highlightjs-line-numbers.min.js"></script>
    <script>hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
    </script>


    
    
</head>

<body>
    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/archives/">Archive</a>
            </li>
            
            <li>
                <a href="/tags/">Tags</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>
        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            <h1>
                <a href="https://wenchao.ren">
                    <span>被遗忘的博客</span>
                </a>
            </h1>
        </div>
        <div class="description">
            <p class="sub_title"></p>
            <div class="my_socials">
                
                
                <a href="https://github.com/xkrivzooh" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                
                <a href="https://weibo.com/AnotherRobot/home" title="weibo" target="_blank"><i class="ri-weibo-fill"></i></a>
                
                
                <a href="https://wenchao.ren/index.xml" type="application/rss+xml" title="rss" target="_blank"><i
                        class="ri-rss-fill"></i></a>
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/error-prone%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8/'>Error Prone的介绍和使用</a></h2>
                    </div>
                    <div class="post_content markdown"><p>Error Prone的介绍和使用</p>
<p>今天在浏览GitHub的时候突然看到Google有一个项目<a href="https://github.com/google/error-prone">Error Prone</a>:</p>
<blockquote>
<p>Catch common Java mistakes as compile-time errors</p>
</blockquote>
<p>官方网站：<a href="https://errorprone.info/">https://errorprone.info/</a></p>
<h2 id="error-prone是什么">Error Prone是什么？</h2>
<p>然后就翻看了一下官方文档了解了一下具体的作用。如果你之前没有了解过这个Error Prone，你可以把他对标为Snoar，FindBugs之类的静态代码分析工具就行。Error Prone就是Google研发的静态代码扫描工具，顾名思义，就是用于扫描Java各种易于出错的代码。</p>
<h2 id="error-prone产生的背景">Error Prone产生的背景</h2>
<p>Google在这篇论文<code>Lessons from Building Static Analysis Tools at Google</code></p>
<ul>
<li>PDF <a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/3198e114c4b70702b27e6d88de2c92734c9ac4c0.pdf">Lessons from Building Static Analysis Tools at Google</a></li>
<li>HTML <a href="https://dl.acm.org/doi/fullHtml/10.1145/3188720">Lessons from Building Static Analysis Tools at Google</a></li>
</ul>
<p>中也提到了Google之前是如何做静态代码分析，以及Error Prone产生的一些原因。简单整理一下就是：</p>
<blockquote>
<p>Google内部早期使用FindBugs作为自己的静态代码分析工具，然后FindBug这种工具一般是定时触发重发，然后生成一个仪表盘，但是问题是大家一般都不会主动去翻看这个仪表盘，因为这个仪表盘不会在开发人员的常规工作流程中，于是Google内部发起了一个<code>FixIt</code>的小活动，简单说就是来集中几天解决这些发现的代码问题，后来他们将FindBugs等分析工具和Code Review工作结合起来搞了一个小平台，但是当时的内部整合不太好，使得开发人员觉的难用，也不怎么信任这个整合平台了。</p>
</blockquote>
<p>于是了，Google内部觉的，这种静态代码分析工作应该是参与到持续继承中，而且最好要<code>快速，频繁，参与到开发人员的常规工作中，并且最好不但要发现问题，还要告诉开发人员怎么修</code>。于是了，Google参考了之前Clang的一个经验，将静态代码分析工作整合到了<code>javac</code>，也就是在编译期来做静态代码分析工作，于是后来就有了这篇文章提到的Error Prone。</p>
<h2 id="error-prone的基本使用">Error Prone的基本使用</h2>
<p>我工作中一直使用的是Intellij+JDK8+Maven，所以参考官方文档<a href="https://errorprone.info/docs/installation">https://errorprone.info/docs/installation</a>，写了一个JDK8使用的小例子。下面贴一下核心代码。</p>
<p>首先是pom.xml中的配置，核心在于<code>maven-compiler-plugin</code>插件的配置, 同时因为大家项目开发过程中一般会使用Lombok等annotation processor依赖，所以下面的实例代码中也展示了ErrorProne如何和Lombok等依赖整合。</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.4.4&lt;/version&gt;
        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
    &lt;/parent&gt;
    &lt;groupId&gt;com.example&lt;/groupId&gt;
    &lt;artifactId&gt;demo&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;demo&lt;/name&gt;
    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;
    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
        &lt;javac.version&gt;9+181-r4173-1&lt;/javac.version&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.google.guava&lt;/groupId&gt;
            &lt;artifactId&gt;guava&lt;/artifactId&gt;
            &lt;version&gt;19.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;version&gt;1.18.18&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;version&gt;3.8.0&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;source&gt;8&lt;/source&gt;
                    &lt;target&gt;8&lt;/target&gt;
                    &lt;encoding&gt;UTF-8&lt;/encoding&gt;
                    &lt;compilerArgs&gt;
                        &lt;arg&gt;-XDcompilePolicy=simple&lt;/arg&gt;
                        &lt;arg&gt;-Xplugin:ErrorProne&lt;/arg&gt;
                    &lt;/compilerArgs&gt;
                    &lt;annotationProcessorPaths&gt;
                        &lt;path&gt;
                            &lt;groupId&gt;com.google.errorprone&lt;/groupId&gt;
                            &lt;artifactId&gt;error_prone_core&lt;/artifactId&gt;
                            &lt;version&gt;2.5.1&lt;/version&gt;
                        &lt;/path&gt;
                        &lt;path&gt;
                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
                            &lt;version&gt;1.18.18&lt;/version&gt;
                        &lt;/path&gt;
                        &lt;!-- Other annotation processors go here.

                        If 'annotationProcessorPaths' is set, processors will no longer be
                        discovered on the regular -classpath; see also 'Using Error Prone
                        together with other annotation processors' below. --&gt;
                    &lt;/annotationProcessorPaths&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;!--    &amp;lt;!&amp;ndash; using github.com/google/error-prone-javac is required when running on JDK 8 &amp;ndash;&amp;gt;--&gt;
&lt;!--    &lt;profiles&gt;--&gt;
&lt;!--        &lt;profile&gt;--&gt;
&lt;!--            &lt;id&gt;jdk8&lt;/id&gt;--&gt;
&lt;!--            &lt;activation&gt;--&gt;
&lt;!--                &lt;jdk&gt;1.8&lt;/jdk&gt;--&gt;
&lt;!--            &lt;/activation&gt;--&gt;
&lt;!--            &lt;build&gt;--&gt;
&lt;!--                &lt;plugins&gt;--&gt;
&lt;!--                    &lt;plugin&gt;--&gt;
&lt;!--                        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;--&gt;
&lt;!--                        &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;--&gt;
&lt;!--                        &lt;configuration&gt;--&gt;
&lt;!--                            &lt;fork&gt;true&lt;/fork&gt;--&gt;
&lt;!--                            &lt;compilerArgs combine.children=&quot;append&quot;&gt;--&gt;
&lt;!--                                &lt;arg&gt;-J-Xbootclasspath/p:${settings.localRepository}/com/google/errorprone/javac/${javac.version}/javac-${javac.version}.jar&lt;/arg&gt;--&gt;
&lt;!--                            &lt;/compilerArgs&gt;--&gt;
&lt;!--                        &lt;/configuration&gt;--&gt;
&lt;!--                    &lt;/plugin&gt;--&gt;
&lt;!--                &lt;/plugins&gt;--&gt;
&lt;!--            &lt;/build&gt;--&gt;
&lt;!--        &lt;/profile&gt;--&gt;
&lt;!--    &lt;/profiles&gt;--&gt;

&lt;/project&gt;
</code></pre>
<p>然后我在我自己的Idea中安装了插件<code>Error Prone Compiler</code> 插件主页：<a href="https://plugins.jetbrains.com/plugin/7349-error-prone-compiler">https://plugins.jetbrains.com/plugin/7349-error-prone-compiler</a></p>
<blockquote>
<p>注意：官方文档中也可以手动指定javac，这个看官网文档就行</p>
</blockquote>
<p>然后修改idea工程配置，将java compiler从默认的<code>javac</code>修改为<code>javac with error-prone</code>。然后工程中写一段测试代码：</p>
<p>测试代码1：</p>
<pre><code class="language-java">import java.util.Set;
import java.util.HashSet;

public class ShortSet {
  public static void main (String[] args) {
    Set&lt;Short&gt; s = new HashSet&lt;&gt;();
    for (short i = 0; i &lt; 100; i++) {
      s.add(i);
      s.remove(i - 1);
    }
    System.out.println(s.size());
  }
}

</code></pre>
<p>测试代码2：</p>
<pre><code class="language-java">import lombok.extern.slf4j.Slf4j;

@Slf4j
public class ArrayToString {

    public void test() {
        String[] array = new String[]{&quot;a&quot;, &quot;b&quot;};
        log.info(array.toString());
    }
}
</code></pre>
<p>然后编译工程，会出现：</p>
<pre><code class="language-java">//针对实例1代码会出现
/Users/xkrivzooh/IdeaProjects/mt/demo/src/main/java/com/example/demo/pattern/ShortSet.java:11:15
java: [CollectionIncompatibleType] Argument 'i - 1' should not be passed to this method; its type int is not compatible with its collection's type argument Short
    (see https://errorprone.info/bugpattern/CollectionIncompatibleType)
  Did you mean '@SuppressWarnings(&quot;CollectionIncompatibleType&quot;) public static void main (String[] args) {'?

//针对实例2代码会出现
/Users/xkrivzooh/IdeaProjects/mt/demo/src/main/java/com/example/demo/pattern/ArrayToString.java:10:18
java: [ArrayToString] Calling toString on an array does not provide useful information
    (see https://errorprone.info/bugpattern/ArrayToString)
  Did you mean 'log.info(Arrays.toString(array));'?
</code></pre>
<p>以上就是Error Prone的基本使用了</p>
<h2 id="error-prone-和findbugssnoar的基本对比">Error Prone 和FindBugs/Snoar的基本对比</h2>
<p>Sonar和FindBugs类似，Sonar和FindBugs做的也非常不错，里面的用例很足，都有不少的公司在用，<strong>但是这种东西最大的问题是，需要开发人员有意识的去使用它</strong>。所以在我呆过的qunar和美团，都是在开发环境的某一个阶段，比如项目提测之前，有一个Sonar等的代码检查阶段来做静态代码分析，然后CM同学会根据是否有阻断性问题来让不让项目提测。但是实际观察来看，很多项目都最终停止掉了代码检查，或者仅仅要求每次发布不新增<code>阻断性问题</code>，也算是一种变相妥协吧。</p>
<p>而Google的这个Error Prone最大的优势就是整合到了javac中，这样开发人员相当于被强制必须FIX问题。所以最终具体用哪个，都还好，只要有意识的去用就是好同学。</p>
</div>
                    <div class="post_footer">
                        
                        <div class="meta">
                            <div class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                    <a href="https://wenchao.ren/tags/java/">java</a>
                                    
                                    <a href="https://wenchao.ren/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                
                <div class="doc_comments"><div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "rollenholt" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div>
                
            </div>
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    <div class="powered_by">
        <a href="https://varkai.com">Designed by VarKai,</a>
        <a href="http://www.gohugo.io/">Proudly published with Hugo</a>
    </div>

    <div class="footer_slogan">
        <span></span>
    </div>
</footer>
    <script src="https://wenchao.ren/js/jquery-3.5.1.min.js"></script>
<link href="https://wenchao.ren/css/fancybox.min.css" rel="stylesheet">
<script src="https://wenchao.ren/js/fancybox.min.js"></script>
<script src="https://wenchao.ren/js/zozo.js"></script>




</body>

</html>